name: Detect Deployment Image Change

on:
  push:
    branches:
      - main
    paths:
      - chapter_argocd/app/default/deployment.yaml
jobs:
  detect-and-validate-change:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Check for Image Changes
        id: check_image_changes
        run: |
          # `deployment.yaml` の変更内容を取得
          CHANGED_IMAGE=$(git diff HEAD^ HEAD -- chapter_argocd/app/default/deployment.yaml | grep '\- image:' | awk '{print $3}' | cut -d':' -f2 | tr -d '\r')
          echo "Detected Changed Image: $CHANGED_IMAGE"

          # blue / green のタグを判定
          if echo "$CHANGED_IMAGE" | grep -q "blue"; then
              echo "Detected a valid image tag: blue"
              echo "change_type=blue" >> $GITHUB_ENV
          elif echo "$CHANGED_IMAGE" | grep -q "green"; then
              echo "Detected a valid image tag: green"
              echo "change_type=green" >> $GITHUB_ENV
          else
              # 無効なタグがあった場合のログを出力
              echo "===================================="
              echo "⚠️ WARNING: Invalid Image Tag Detected"
              echo "Detected Unsupported Image Tag: $CHANGED_IMAGE"
              echo "File: chapter_argocd/app/default/deployment.yaml"
              echo "Please ensure the image tag is either 'blue' or 'green'."
              echo "===================================="

              # 詳細ログを保存
              echo "Detected Invalid Image Version: $CHANGED_IMAGE" | tee -a INVALID_IMAGE_ALERT.log
              echo "change_type=invalid" >> $GITHUB_ENV

              # ワークフローを失敗させる
              exit 1
          fi
